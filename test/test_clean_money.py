from data_processing_utils import split_supplier_address_for_template, split_customer_address_for_template, clean_json_for_peppol, build_invoice_lines
from authentication_utils import authenticate_drive, upload_xml_memory, save_token, load_token
from tickstar_utils import call_tickstar_api
from webhook_utils_1 import send_push_notification, post_data_to_appsheet_whc, post_data_to_appsheet_pc
# IMPORTS
import uuid
import functions_framework
import os
import re
import pandas as pd
import json
import xml.etree.ElementTree as ET
import google.auth
# FROM OTHER LIBS
from datetime import datetime, timezone
from flask import request, Response, jsonify
from jinja2 import Environment, FileSystemLoader, select_autoescape
from pathlib import Path
from collections import defaultdict
from urllib.parse import quote

data = {
    "Customer ID": "964dbdf0",
    "Car ID": "ad43242c",
    "Create Pro Forma doc": "1",
    "Pro Forma date": "7-11-2024",
    "Pro forma doc upload": "",
    "Factuur doc upload": "",
    "Ander doc upload": "",
    "Pro Forma doc creation date": "7-11-2024 12:17:27",
    "Pro Forma document": "",
    "Pro Forma Attachment": "",
    "Pro Forma Sent to customer": "Y",
    "Pro Forma Sent Date": "7-11-2024 12:18:26",
    "Pro Forma Resent date": "",
    "Pro Forma Approved": "Y",
    "Pro Forma Approved Date": "7-11-2024",
    "Pro Forma VAT statement": "",
    "Pro Forma VAT regime": "Verkoop in België met BTW",
    "Pro Forma VAT percentage": "21,00%",
    "Pro Forma Comment": "",
    "e_invoice_sent": "Y",
    "Invoice number": "301",
    "Invoice date": "14-11-2024",
    "Invoice doc creation date": "14-11-2024 17:31:46",
    "Invoice Sent to customer": "Y",
    "Invoice Sent Date": "14-11-2024 17:32:50",
    "Invoice Approved": "N",
    "Invoice Approved Date": "",
    "Invoice Comment": "Referte 2131495/003",
    "Invoice paid": "Y",
    "Invoice rejected": "N",
    "Invoice rejected date": "",
    "CN number": "",
    "Create CN doc": "",
    "CN date": "",
    "CN doc creation date": "",
    "CN document": "",
    "CN Sent to customer": "N",
    "CN Sent Date": "",
    "CN Resent": "",
    "CN Resent date": "",
    "CN Approved": "N",
    "CN Approved Date": "",
    "CN Comment": "",
    "VAT to recup": "",
    "P_supplier_id": "34ae6edb",
    "P_payment_reference": "",
    "P_payment_terms_note": "",
    "P_TaxCategory_ID": "",
    "e_invoice_sent_57": "",
    "e_invoice_sent_date": "17-6-2025",
    "Customer Name": "Van Breda Car Finance",
    "Customer Address 1": "Ledeganckkaai 7",
    "Customer address 2": " 2000 Antwerpen 1",
    "Customer address 3": " 2000 Antwerpen 1",
    "VAT Nr": "BE 0404.055.577",
    "Pro Forma Car brand": "Volkswagen",
    "Pro Forma Car model": "Touareg TDI",
    "Pro Forma Car picture": "",
    "Pro Forma Sales price": "€ 74.950,00",
    "Pro Forma VAT": "€ 13.007,85",
    "Pro Forma Sales price ex VAT": "€ 61.942,15",
    "Pro Forma Car chassis nr": "WVGZZZCRXSD003006",
    "Pro Forma Car color": "Black",
    "Pro Forma Car engine size": "2.967",
    "Pro Forma Car power": "170",
    "Pro Forma Car mileage": "25",
    "Pro Forma Car first registration": "14-10-2024",
    "Pro Forma Car extras": "",
    "Customer phone 1": "",
    "Customer phone 2": "03 245 78 00",
    "Customer email": "",
    "Customer invoicing email": "uitbetalingen@vanbredacarfinance.com",
    "Invoice exists": "Y",
    "Proforma doc created": "Y",
    "Invoice activated": "Y",
    "Invoice doc generated": "Y",
    "Last invoice number": "35",
    "last Pro Forma number": "01",
    "last CN number": "0",
    "Car-Chassis-Customer": "Volkswagen Touareg TDI 003006 - Van Breda Car Finance",
    "Invoice number for doc": "F#2024-0401 (Volkswagen Touareg TDI 003006 - Van Breda Car Finance)-9128b04e",
    "CN number for doc": "",
    "Pro Forma number for doc": "PF#2024-110701 (Volkswagen Touareg TDI 003006 - Van Breda Car Finance)-9128b04e",
    "Invoice number 4 digits": "0401",
    "Invoice number for template": "2024-0401",
    "Pro Forma number for template": "2024-110701",
    "Pro Forma customer logo": "",
    "Todays pro forma number base": "2.025.617",
    "Invoice number yearbase": "2024",
    "Invoice number base": "100",
    "Pro Forma number complete": "2024-11701",
    "Invoice date ref": "14-11-2024",
    "Pro forma label": "Volkswagen-Touareg TDI-Van Breda Car Finance-9128b04e",
    "Pro forma approved date ref": "7-11-2024",
    "Proforma date ref": "7-11-2024",
    "Proforma number yearbase": "2024",
    "CN number 4 digits": "0100",
    "CN number for template": "",
    "Actions": "",
    "Pro forma for this car": "3f5c3645 , 9128b04e",
    "Another pro forma approved": "Y",
    "Invoice nrs found in folder": "20240456",
    "Invoice File": "https://www.appsheet.com/template/gettablefileurl?appName=PetrolCaveAutohandel-346984636&tableName=Pro%20Forma&fileName=Petrol%20Cave%20Groothandel%2FInvoice%20files%2FF%232024-0401%20%28Polestar%202%20163353%20-%20Norcar%29-a6b6ab2c.pdf&appVersion=1.002281&signature=ea105a3e6c82719faa1a600bc29853eedfbcf653e1d90b28264777ed8d4b344f07cae30a6bab13147c67d01e719830b9",
    "CN File": "",
    "Invoice number 8 digits": "20240401",
    "CN number 8 digits": "20240100",
    "Proforma File": "https://www.appsheet.com/template/gettablefileurl?appName=PetrolCaveAutohandel-346984636&tableName=Pro%20Forma&fileName=Petrol%20Cave%20Groothandel%2FProforma%20invoice%20files%2FPF%232024-110701%20%28Volkswagen%20Touareg%20TDI%20003006%20-%20Van%20Breda%20Car%20Finance%29-9128b04e.pdf&appVersion=1.002281&signature=aaacd086aa8891d8b6fd4d67ccee90b747450cf5ea397132e32e031b04799ef5942f408bba9298fb3f577073d4f9e3ff",
    "Proforma number 10 digits": "2024110701",
    "Proforma nrs found in folder": "2024110701",
    "Proforma Chassis nr shortname": "003006",
    "Pro Forma Car first registration (EU formatted date)": "14/10/2024",
    "Pro Forma date (EU formatted date)": "7/11/2024",
    "Invoice date (EU formatted date)": "14/11/2024",
    "Pro Forma Sales price ex VAT(EU)": "61.942,15",
    "Pro Forma Sales price(EU)": "74.950,00",
    "Pro Forma VAT(EU)": "13.007,85",
    "Pro Forma Car Weight": "2.043",
    "Customer delivery Address": "Tijp hier het leveradres",
    "Other delivery address?": "N",
    "Showed delivery address": "",
    "Customer Invoicing Address 1": "Ledeganckkaai 7",
    "Customer invoicing Address 2": " 2000 Antwerpen 1",
    "Customer Invoicing Address 3": " 2000 Antwerpen 1",
    "Invoice date calendar date": "14-11-2024",
    "Bookyear invoice date": "2.024",
    "CN date calendar date": "",
    "Bookyear cn date": "",
    "P_supplier_trade_name": "Petrol Cave",
    "P_supplier_address": "Puursesteenweg 339, 2880 Bornem, Belgium",
    "P_supplier_vat_nr": "BE0722.580.219",
    "P_supplier_legal_name": "Petrol Cave bv",
    "P_supplier_endpoint": "722.580.219",
    "P_supplier_contact_name": "Bart De Winter",
    "P_supplier_contact_tel": "+32475303986",
    "P_supplier_contact_email": "bart@petrolcave.be",
    "P_supplier_country_id": "BE",
    "P_supplier_legal_form": "BV",
    "P_customer_trade_name": "Van Breda Car Finance",
    "P_customer_address": " 2000 Antwerpen 1",
    "P_customer_country_id": "",
    "P_customer_legal_name": "",
    "P_customer_legal_form": "",
    "P_customer_contact_name": " ",
    "P_customer_contact_tel": "",
    "P_customer_contact_email": "",
    "P_customer_vat_nr": "BE 0404.055.577",
    "P_customer_endpoint": "",
    "P_payee_financial_account_id": "GKCC BE BB",
    "P_payee_financial_account_bic": "GKCC BE BB",
    "VAT percentage": "21,00%",
    "To be paid before": "14-11-2024",
    "PO": "2024110701",
    "Total VAT": "€ 13.007,85",
    "TaxableAmount": "€ 61.942,15",
    "TaxAmount": "€ 13.007,85",
    "TaxCategory_Percent": "21,00%",
    "TaxExemptionReason": "Voertuig bestemd voor wederverkoop, verkoop tussen handelaren zonder garantie",
    "TaxScheme_ID": "VAT",
    "Total ex VAT": "€ 61.942,15",
    "Total incl VAT": "€ 74.950,00",
    "Invoice_line_description": "Merk, model: Volkswagen Touareg TDI; Chassis nr: \n WVGZZZCRXSD003006; Kleur: Black; Cilinderinhoud: 2967; Vermogen: 170 kW; Kilometerstand: 25; Datum 1e inschrijving: 14/10/2024; Gewicht: 2043kg",
    "P_unit_code": "C62",
    "Unit_fee": "€ 61.942,15",
    "P_vat_category": "S",
    "TaxCategory_ID": "S",
    "P_invoice_typecode": "380"
}
invoice_data = clean_json_for_peppol(data)
print("CLEANED JSON: ", json.dumps(invoice_data, indent=2))